name: Release Tool

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag (ex: v1.2.3)"
        required: true
      release_title:
        description: "Release title"
        required: true
      release_body:
        description: "Release notes"
        required: false
      draft:
        description: "Create as draft"
        required: false
        type: boolean
      prerelease:
        description: "Create as prerelease"
        required: false
        type: boolean

jobs:
  android-version-up:
    name: Android Version Up (no commit)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Bump Android version
        run: |
          FILE=app/build.gradle

          CURRENT_CODE=$(grep -oP 'versionCode\s+\K\d+' $FILE | head -1)
          NEXT_CODE=$((CURRENT_CODE + 1))

          echo "Before versionName:"
          grep versionName $FILE

          sed -i -E "s/(versionCode[[:space:]]+)[0-9]+/\1$NEXT_CODE/" $FILE
          # Handles both versionName "1.2.3" and versionName '1.2.3'
          sed -i -E "s/(versionName[[:space:]]+)[\'\"][^\'\"]*[\'\"]/versionName \"${{ github.event.inputs.tag_name }}\"/" $FILE

          echo "After versionName:"
          grep versionName $FILE

          echo "versionCode=$NEXT_CODE" >> $GITHUB_ENV

      - uses: actions/upload-artifact@v7
        with:
          name: versioned-source
          path: app/build.gradle

  android:
    name: Android Release Build
    needs: android-version-up
    uses: ./.github/workflows/release.yml
    secrets: inherit

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs:
      - android

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist

      - name: Debug dist files
        run: ls -R dist

      - name: Rename APK files
        run: |
          find dist -name "app-*.apk" | while read file; do
            base=$(basename "$file")
            dir=$(dirname "$file")
            new_name=$(echo "$base" \
              | sed 's/^app-/tech.treeentertainment.camera./' \
              | sed 's/-/./g')
            mv "$file" "$dir/$new_name"
          done

      - name: Upload release files as artifact
        uses: actions/upload-artifact@v7
        with:
          name: release-files-${{ github.run_id }}
          path: |
            dist/**/*.apk
          retention-days: 14

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Write raw release notes
        run: |
          if [ -z "${{ github.event.inputs.release_body }}" ]; then
            echo "No release notes provided." > RELEASE_NOTES.md
          else
            printf "%s\n" "${{ github.event.inputs.release_body }}" > RELEASE_NOTES.md
          fi

      - name: Prettify release notes
        run: |
          npm install -g prettier@latest
          prettier RELEASE_NOTES.md \
            --write \
            --print-width 72 \
            --prose-wrap always

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          name: ${{ github.event.inputs.release_title }}
          body_path: RELEASE_NOTES.md
          draft: ${{ github.event.inputs.draft }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            dist/**/*.apk

  commit-version-release:
    name: Commit version bump after release
    runs-on: ubuntu-latest
    needs: release

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v7
        with:
          name: versioned-source
          path: app

      - name: Setup git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit & push
        run: |
          git add app/build.gradle
          git commit -m "chore(android): bump version to ${{ github.event.inputs.tag_name }}"
          git push
